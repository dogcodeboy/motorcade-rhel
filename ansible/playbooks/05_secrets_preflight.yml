---
- name: Secrets Manager preflight for Keycloak
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Assert Keycloak DB secret ARN is set
      ansible.builtin.assert:
        that:
          - keycloak_db_secret_arn | default('') | trim | length > 0
        fail_msg: "keycloak_db_secret_arn must be set before running Keycloak deployment."

    - name: Validate access to Keycloak secret in Secrets Manager
      ansible.builtin.command:
        cmd: >-
          aws secretsmanager get-secret-value
          --secret-id {{ keycloak_db_secret_arn }}
          --query ARN
          --output text
      register: keycloak_secret_preflight
      changed_when: false
      no_log: true
