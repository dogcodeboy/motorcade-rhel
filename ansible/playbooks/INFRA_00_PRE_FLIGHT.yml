---
- name: INFRA_00_PRE_FLIGHT | RHEL CDN repo baseline + cache hygiene
  hosts: motorcade
  become: true
  gather_facts: true
  vars:
    motorcade_repo_preflight_enabled: false

  tasks:
    - name: Skip repo preflight unless explicitly enabled
      ansible.builtin.meta: end_play
      when: not motorcade_repo_preflight_enabled | bool

    - name: Enable subscription-manager DNF plugin for CDN repos
      ansible.builtin.ini_file:
        path: /etc/dnf/plugins/subscription-manager.conf
        section: main
        option: enabled
        value: "1"
        create: true
        mode: "0644"

    - name: Ensure dnf-plugins-core installed
      ansible.builtin.package:
        name: dnf-plugins-core
        state: present

    - name: Clean DNF cache
      ansible.builtin.command:
        cmd: dnf clean all
      changed_when: false

    - name: Remove DNF cache directory
      ansible.builtin.file:
        path: /var/cache/dnf
        state: absent

    - name: Rebuild DNF cache
      ansible.builtin.command:
        cmd: dnf makecache
      changed_when: false

    - name: Capture active repositories after pre-flight
      ansible.builtin.command:
        cmd: dnf repolist
      register: repolist_out
      changed_when: false
