
- name: Assert RDS-only mode
  ansible.builtin.assert:
    that:
      - keycloak_db_mode | lower == "rds"
    fail_msg: "Refusing to run: keycloak_db_mode must be 'rds' (no local Postgres containers allowed)."

- name: Assert required Keycloak vars
  ansible.builtin.assert:
    that:
      - keycloak_db_host | trim | length > 0
      - keycloak_db_name | trim | length > 0
      - keycloak_db_user | trim | length > 0
      - keycloak_db_secret_arn | trim | length > 0
      - keycloak_hostname | trim | length > 0
      - keycloak_admin_user | trim | length > 0
      - keycloak_admin_password | trim | length > 0
    fail_msg: "Missing required Keycloak vars (DB host/name/user/secret ARN, hostname, or admin secret ARN)."

- name: Check Podman candidate paths
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ podman_bin_candidates }}"
  register: keycloak_podman_candidates

- name: Resolve Podman binary path
  ansible.builtin.set_fact:
    keycloak_podman_bin: >-
      {{
        (keycloak_podman_candidates.results
        | selectattr('stat.exists')
        | map(attribute='stat.path')
        | list
        | first) | default('')
      }}
  changed_when: false

- name: Assert Podman is available
  ansible.builtin.assert:
    that:
      - keycloak_podman_bin | length > 0
    fail_msg: "Podman is missing. Rebake the image with Podman installed."

- name: Ensure Keycloak audit directory exists
  ansible.builtin.file:
    path: "{{ keycloak_audit_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0750"

- name: Ensure Keycloak runtime directory exists
  ansible.builtin.file:
    path: "{{ keycloak_runtime_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Ensure Keycloak data directories exist (readonly rootfs compatible)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - path: /srv/motorcade/keycloak
      owner: root
      group: root
      mode: "0750"
    - path: /srv/motorcade/keycloak/data
      owner: "1000"
      group: "0"
      mode: "0750"
    - path: /srv/motorcade/keycloak/data/tmp
      owner: "1000"
      group: "0"
      mode: "0770"

- name: Ensure SELinux tools are present for Keycloak data labeling
  ansible.builtin.package:
    name:
      - policycoreutils-python-utils
    state: present
  failed_when: false

- name: Persist SELinux context for Keycloak data path
  ansible.builtin.shell: |
    set -euo pipefail
    if semanage fcontext -l | grep -Fq "/srv/motorcade/keycloak/data(/.*)?"; then
      semanage fcontext -m -t container_file_t "/srv/motorcade/keycloak/data(/.*)?"
    else
      semanage fcontext -a -t container_file_t "/srv/motorcade/keycloak/data(/.*)?"
    fi
  args:
    executable: /bin/bash
  changed_when: false
  failed_when: false

- name: Apply SELinux labels to Keycloak data path
  ansible.builtin.command:
    argv:
      - restorecon
      - -Rv
      - /srv/motorcade/keycloak/data
  changed_when: false
  failed_when: false

- name: Ensure Keycloak Podman network exists
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} network exists {{ keycloak_network_name }}"
  register: keycloak_network_exists
  failed_when: false
  changed_when: false

- name: Create Keycloak Podman network
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} network create {{ keycloak_network_name }}"
  when: keycloak_network_exists.rc != 0
  changed_when: true

- name: Fetch Keycloak DB secret JSON from Secrets Manager
  ansible.builtin.command:
    cmd: >-
      aws secretsmanager get-secret-value
      --secret-id {{ keycloak_db_secret_arn }}
      --query SecretString
      --output text
  register: keycloak_db_secret_raw
  changed_when: false
  no_log: true

- name: Parse Keycloak DB secret JSON
  ansible.builtin.set_fact:
    keycloak_db_secret: "{{ keycloak_db_secret_raw.stdout | from_json }}"
  changed_when: false
  no_log: true

- name: Fetch Keycloak admin secret JSON from Secrets Manager
  ansible.builtin.command:
    cmd: >-
      aws secretsmanager get-secret-value --secret-id {{ keycloak_admin_secret_arn }}
      --query SecretString --output text
  register: keycloak_admin_secret_raw
  changed_when: false
  no_log: true

- name: Parse Keycloak admin secret JSON
  ansible.builtin.set_fact:
    keycloak_admin_secret: "{{ keycloak_admin_secret_raw.stdout | from_json }}"
  changed_when: false
  no_log: true

- name: Resolve Keycloak admin creds from secret
  ansible.builtin.set_fact:
    keycloak_admin_user_effective: "{{ keycloak_admin_secret.username | default('') }}"
    keycloak_admin_password_effective: "{{ keycloak_admin_secret.password | default('') }}"
  changed_when: false
  no_log: true

- name: Assert Keycloak admin creds are present in secret
  ansible.builtin.assert:
    that:
      - keycloak_admin_user_effective | length > 0
      - keycloak_admin_password_effective | length > 0
    fail_msg: "Keycloak admin secret must include non-empty username and password."

- name: Resolve Keycloak DB credentials from secret
  ansible.builtin.set_fact:
    keycloak_db_username: "{{ keycloak_db_secret.username | default(keycloak_db_user) }}"
    keycloak_db_password_effective: "{{ keycloak_db_secret.password | default('') }}"
  changed_when: false
  no_log: true

- name: Assert Keycloak DB password is present in secret
  ansible.builtin.assert:
    that:
      - keycloak_db_password_effective | length > 0
    fail_msg: "Secrets Manager value must include a non-empty password."

- name: Write ephemeral Keycloak DB env file
  ansible.builtin.copy:
    dest: "{{ keycloak_runtime_dir }}/db.env"
    owner: root
    group: root
    mode: "0600"
    content: |
      KC_DB_USERNAME={{ keycloak_db_username }}
      KC_DB_PASSWORD={{ keycloak_db_password_effective }}
  no_log: true
- name: Force remove existing Keycloak container (guarantee new flags apply)
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} rm -f {{ keycloak_container_name }}"
  ignore_errors: true
  changed_when: false


- name: Check Keycloak container presence
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} container exists {{ keycloak_container_name }}"
  register: keycloak_container_exists
  failed_when: false
  changed_when: false

- name: Fetch Keycloak secrets (AWS Secrets Manager) + build runtime env
  block:
    - name: Assert Keycloak secret IDs are set
      ansible.builtin.assert:
        that:
          - keycloak_db_secret_id | length > 0
          - keycloak_admin_secret_id | length > 0
          - keycloak_hostname | length > 0
          - keycloak_proxy_headers | length > 0
        fail_msg: >
          Missing secret IDs. Set keycloak_db_secret_id and keycloak_admin_secret_id
          in inventory/group_vars for this environment.

    - name: Verify AWS CLI is available on the host
      ansible.builtin.command: aws --version
      register: aws_cli_version
      changed_when: false

    - name: Fetch Keycloak DB secret JSON (SecretString)
      ansible.builtin.command:
        argv:
          - aws
          - secretsmanager
          - get-secret-value
          - --secret-id
          - "{{ keycloak_db_secret_id }}"
          - --query
          - SecretString
          - --output
          - text
      register: kc_db_secret_raw
      changed_when: false
      no_log: true

    - name: Fetch Keycloak admin secret JSON (SecretString)
      ansible.builtin.command:
        argv:
          - aws
          - secretsmanager
          - get-secret-value
          - --secret-id
          - "{{ keycloak_admin_secret_id }}"
          - --query
          - SecretString
          - --output
          - text
      register: kc_admin_secret_raw
      changed_when: false
      no_log: true

    - name: Parse secrets
      ansible.builtin.set_fact:
        kc_db_secret: "{{ kc_db_secret_raw.stdout | from_json }}"
        kc_admin_secret: "{{ kc_admin_secret_raw.stdout | from_json }}"
      no_log: true

    
    - name: Assert Keycloak secret schema has required keys (no values printed)
      ansible.builtin.assert:
        that:
          # DB secret
          - kc_db_secret is mapping
          - (kc_db_secret.username is defined) or (kc_db_secret.user is defined)
          - kc_db_secret.password is defined
          - (kc_db_secret.host is defined) or (kc_db_secret.hostname is defined) or (kc_db_secret.endpoint is defined)
          # Admin secret
          - kc_admin_secret is mapping
          - kc_admin_secret.password is defined
        fail_msg: >
          Secret JSON schema mismatch. Expected DB keys: host/hostname/endpoint, username/user, password
          and Admin keys: password (username/user optional). Fix Secrets Manager SecretString JSON.

    - name: Normalize Keycloak secret schema for templates
      ansible.builtin.set_fact:
        kc_db:
          host: "{{ kc_db_secret.host | default(kc_db_secret.hostname) | default(kc_db_secret.endpoint) }}"
          port: "{{ kc_db_secret.port | default(5432) }}"
          dbname: "{{ kc_db_secret.dbname | default(kc_db_secret.dbName) | default('keycloak') }}"
          username: "{{ kc_db_secret.username | default(kc_db_secret.user) }}"
          password: "{{ kc_db_secret.password }}"
        kc_admin:
          username: "{{ (kc_admin_secret.username | default(kc_admin_secret.user)) | default('admin') }}"
          password: "{{ kc_admin_secret.password }}"
      no_log: true

    - name: Render role template into env text (in-memory only)
      ansible.builtin.set_fact:
        keycloak_runtime_env_text: "{{ lookup('template', 'keycloak.env.j2') }}"
      no_log: true

    - name: Parse env text into dict for Ansible environment injection
      ansible.builtin.set_fact:
        keycloak_runtime_env: "{{ dict(
          (keycloak_runtime_env_text.splitlines()
            | reject('match','^\\s*$')
            | map('split', '=', 1)
            | list)
        ) }}"
      no_log: true

    - name: Write runtime Keycloak env file for quadlet
      ansible.builtin.copy:
        dest: "{{ keycloak_runtime_dir }}/keycloak.env"
        owner: root
        group: root
        mode: "0600"
        content: "{{ keycloak_runtime_env_text ~ '\n' }}"
      no_log: true
      when: keycloak_use_quadlet | bool
  when: not ansible_check_mode

- name: Build Keycloak once (kc.sh build with full runtime config)
  ansible.builtin.command:
    cmd: >-
      {{ keycloak_podman_bin }} run --rm
      --network {{ keycloak_network_name }}
      --env KEYCLOAK_ADMIN
      --env KEYCLOAK_ADMIN_PASSWORD
      --env KC_DB
      --env KC_DB_URL_HOST
      --env KC_DB_URL_PORT
      --env KC_DB_URL_DATABASE
      --env KC_PROXY
      --env KC_HOSTNAME
      --env KC_HOSTNAME_STRICT
      --env KC_HTTP_ENABLED
      --volume /srv/motorcade/keycloak/data:/opt/keycloak/data:z
      --tmpfs /tmp:rw,noexec,nosuid,nodev
      --tmpfs /run:rw,noexec,nosuid,nodev
      {{ keycloak_image }}
      build
  environment: "{{ keycloak_runtime_env }}"
  register: kc_build
  changed_when: kc_build.rc == 0
  failed_when: kc_build.rc != 0
  when: not keycloak_use_quadlet | bool



- name: Ensure Keycloak state directory exists
  ansible.builtin.file:
    path: "/var/lib/motorcade/keycloak"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: not keycloak_use_quadlet | bool

- name: Check whether Keycloak first start is complete
  ansible.builtin.stat:
    path: "/var/lib/motorcade/keycloak/.first_start_complete"
  register: keycloak_first_start_marker

- name: Build optimized Keycloak image (kc.sh build, no secrets)
  block:
    - name: Ensure Keycloak image build directory exists
      ansible.builtin.file:
        path: "{{ keycloak_image_build_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Render optimized Containerfile (no secrets)
      ansible.builtin.template:
        src: "Containerfile.optimized.j2"
        dest: "{{ keycloak_containerfile_path }}"
        owner: root
        group: root
        mode: "0644"

    - name: Check whether optimized Keycloak image already exists
      ansible.builtin.command:
        argv:
          - "{{ keycloak_podman_bin }}"
          - image
          - exists
          - "{{ keycloak_optimized_image }}"
      register: keycloak_optimized_image_exists
      changed_when: false
      failed_when: false

    - name: Build optimized Keycloak image (no secrets baked)
      ansible.builtin.command:
        argv:
          - "{{ keycloak_podman_bin }}"
          - build
          - -t
          - "{{ keycloak_optimized_image }}"
          - -f
          - "{{ keycloak_containerfile_path }}"
          - "{{ keycloak_image_build_dir }}"
      when: keycloak_optimized_image_exists.rc != 0
      changed_when: true

- name: Ensure quadlet directory exists
  ansible.builtin.file:
    path: /etc/containers/systemd
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: keycloak_use_quadlet | bool

- name: Render Keycloak quadlet definition
  ansible.builtin.template:
    src: motorcade-keycloak.container.j2
    dest: "/etc/containers/systemd/{{ keycloak_container_name }}.container"
    owner: root
    group: root
    mode: "0644"
  when: keycloak_use_quadlet | bool

- name: Remove existing standalone Keycloak container before quadlet startup
  ansible.builtin.command:
    argv:
      - "{{ keycloak_podman_bin }}"
      - rm
      - -f
      - "{{ keycloak_container_name }}"
  changed_when: false
  failed_when: false
  when: keycloak_use_quadlet | bool

- name: Reload systemd daemon after quadlet render
  ansible.builtin.systemd:
    daemon_reload: true
  when: keycloak_use_quadlet | bool

- name: Enable and start Keycloak quadlet service
  ansible.builtin.systemd:
    name: "{{ keycloak_container_name }}.service"
    enabled: true
    state: started
  when: keycloak_use_quadlet | bool


- name: Create Keycloak container (first start bootstrap, no optimized)
  ansible.builtin.command:
    cmd: >-
      {{ keycloak_podman_bin }} run -d
      --replace
      --name {{ keycloak_container_name }}
      --network {{ keycloak_network_name }}
      --env KC_DB_PASSWORD
      --env KC_DB_USERNAME
      --env KC_DB_URL
      --env KC_HTTP_ENABLED
      --env KC_HOSTNAME_STRICT
      --env KC_HOSTNAME
      --env KC_PROXY
      --env KC_DB
      --env KC_BOOTSTRAP_ADMIN_PASSWORD
      --env KC_BOOTSTRAP_ADMIN_USERNAME

      --tmpfs /run:rw,noexec,nosuid,nodev
      --tmpfs /tmp:rw,noexec,nosuid,nodev
      --tmpfs /opt/keycloak/.cache:rw,noexec,nosuid,nodev
      --tmpfs /opt/keycloak/lib/quarkus:rw,noexec,nosuid,nodev
      --tmpfs /opt/keycloak/conf:rw,noexec,nosuid,nodev
      --volume /srv/motorcade/keycloak/data:/opt/keycloak/data:z
      --cap-drop=ALL
      --pids-limit 200
      --memory 1g
      -p 127.0.0.1:8081:8080
      {{ keycloak_image }}
      start --hostname {{ keycloak_hostname }} --http-enabled true --proxy-headers {{ keycloak_proxy_headers }}
  environment: "{{ keycloak_runtime_env }}"
  changed_when: true
  when:
    - keycloak_container_exists.rc != 0
    - not keycloak_first_start_marker.stat.exists
    - not keycloak_use_quadlet | bool

- name: Wait for Keycloak HTTP to be reachable on first start
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: 8081
    delay: 2
    timeout: 180
  when:
    - not keycloak_first_start_marker.stat.exists
    - not keycloak_use_quadlet | bool

- name: Stop Keycloak container after first start bootstrap
  ansible.builtin.command:
    argv:
      - "{{ keycloak_podman_bin }}"
      - stop
      - -t
      - "10"
      - "{{ keycloak_container_name }}"
  changed_when: true
  failed_when: false
  when:
    - not keycloak_first_start_marker.stat.exists
    - not keycloak_use_quadlet | bool

- name: Remove bootstrap container before optimized recreate
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} rm -f {{ keycloak_container_name }}"
  changed_when: true
  failed_when: false
  when:
    - not keycloak_first_start_marker.stat.exists
    - not keycloak_use_quadlet | bool

- name: Mark Keycloak first start complete
  ansible.builtin.file:
    path: "/var/lib/motorcade/keycloak/.first_start_complete"
    state: touch
    owner: root
    group: root
    mode: "0644"
  when:
    - not keycloak_first_start_marker.stat.exists
    - not keycloak_use_quadlet | bool

- name: Refresh Keycloak first-start marker state
  ansible.builtin.stat:
    path: "/var/lib/motorcade/keycloak/.first_start_complete"
  register: keycloak_first_start_marker

- name: Create Keycloak container (optimized steady-state)
  ansible.builtin.command:
    cmd: >-
      {{ keycloak_podman_bin }} run -d
      --replace
      --name {{ keycloak_container_name }}
      --network {{ keycloak_network_name }}
      --env KC_DB_PASSWORD
      --env KC_DB_USERNAME
      --env KC_DB_URL
      --env KC_HTTP_ENABLED
      --env KC_HOSTNAME_STRICT
      --env KC_HOSTNAME
      --env KC_PROXY
      --env KC_DB
      --read-only
      --tmpfs /run:rw,noexec,nosuid,nodev
      --tmpfs /tmp:rw,noexec,nosuid,nodev
      --volume /srv/motorcade/keycloak/data:/opt/keycloak/data:z
      --cap-drop=ALL
      --pids-limit 200
      --memory 1g
      -p 127.0.0.1:8081:8080
      {{ keycloak_optimized_image }}
      start --optimized --hostname {{ keycloak_hostname }} --http-enabled true --proxy-headers {{ keycloak_proxy_headers }}
  environment: "{{ keycloak_runtime_env }}"
  changed_when: true
  when:
    - keycloak_container_exists.rc != 0
    - keycloak_first_start_marker.stat.exists
    - not keycloak_use_quadlet | bool

- name: Capture Keycloak audit artifacts
  ansible.builtin.shell: |
    set -euo pipefail
    {{ keycloak_podman_bin }} inspect {{ keycloak_container_name }} > {{ keycloak_audit_dir }}/keycloak_container_inspect.json
    {{ keycloak_podman_bin }} image inspect {{ keycloak_image }} > {{ keycloak_audit_dir }}/keycloak_image_inspect.json
    cat > {{ keycloak_audit_dir }}/keycloak_config_effective.txt <<'CFG'
    keycloak_container_name={{ keycloak_container_name }}
    keycloak_image={{ keycloak_image }}
    keycloak_network_name={{ keycloak_network_name }}
    keycloak_bind=127.0.0.1:8081->8080
    keycloak_db_mode={{ keycloak_db_mode }}
    keycloak_db_host={{ keycloak_db_host }}
    keycloak_db_port={{ keycloak_db_port }}
    keycloak_db_name={{ keycloak_db_name }}
    keycloak_db_user={{ keycloak_db_username }}
    keycloak_hostname={{ keycloak_hostname }}
    keycloak_hostname_strict={{ keycloak_hostname_strict | ternary('true', 'false') }}
    CFG
    printf '%s\n' '{{ keycloak_db_secret_arn }}' > {{ keycloak_audit_dir }}/keycloak_secret_arn_used.txt
  changed_when: true
  environment: "{{ keycloak_runtime_env }}"
