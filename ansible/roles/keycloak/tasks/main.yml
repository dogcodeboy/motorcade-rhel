---
- name: Assert RDS-only mode
  ansible.builtin.assert:
    that:
      - keycloak_db_mode | lower == "rds"
    fail_msg: "Refusing to run: keycloak_db_mode must be 'rds' (no local Postgres containers allowed)."

- name: Assert required Keycloak vars
  ansible.builtin.assert:
    that:
      - keycloak_db_host | trim | length > 0
      - keycloak_db_name | trim | length > 0
      - keycloak_db_user | trim | length > 0
      - keycloak_db_secret_arn | trim | length > 0
      - keycloak_hostname | trim | length > 0
      - keycloak_admin_user | trim | length > 0
      - keycloak_admin_password | trim | length > 0
    fail_msg: "Missing required Keycloak vars (DB host/name/user/secret ARN, hostname, or admin secret ARN)."

- name: Check Podman candidate paths
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ podman_bin_candidates }}"
  register: keycloak_podman_candidates

- name: Resolve Podman binary path
  ansible.builtin.set_fact:
    keycloak_podman_bin: >-
      {{
        (keycloak_podman_candidates.results
        | selectattr('stat.exists')
        | map(attribute='stat.path')
        | list
        | first) | default('')
      }}
  changed_when: false

- name: Assert Podman is available
  ansible.builtin.assert:
    that:
      - keycloak_podman_bin | length > 0
    fail_msg: "Podman is missing. Rebake the image with Podman installed."

- name: Ensure Keycloak audit directory exists
  ansible.builtin.file:
    path: "{{ keycloak_audit_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0750"

- name: Ensure Keycloak runtime directory exists
  ansible.builtin.file:
    path: "{{ keycloak_runtime_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Ensure Keycloak Podman network exists
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} network exists {{ keycloak_network_name }}"
  register: keycloak_network_exists
  failed_when: false
  changed_when: false

- name: Create Keycloak Podman network
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} network create {{ keycloak_network_name }}"
  when: keycloak_network_exists.rc != 0
  changed_when: true

- name: Fetch Keycloak DB secret JSON from Secrets Manager
  ansible.builtin.command:
    cmd: >-
      aws secretsmanager get-secret-value
      --secret-id {{ keycloak_db_secret_arn }}
      --query SecretString
      --output text
  register: keycloak_db_secret_raw
  changed_when: false
  no_log: true

- name: Parse Keycloak DB secret JSON
  ansible.builtin.set_fact:
    keycloak_db_secret: "{{ keycloak_db_secret_raw.stdout | from_json }}"
  changed_when: false
  no_log: true

- name: Fetch Keycloak admin secret JSON from Secrets Manager
  ansible.builtin.command:
    cmd: >-
      aws secretsmanager get-secret-value --secret-id {{ keycloak_admin_secret_arn }}
      --query SecretString --output text
  register: keycloak_admin_secret_raw
  changed_when: false
  no_log: true

- name: Parse Keycloak admin secret JSON
  ansible.builtin.set_fact:
    keycloak_admin_secret: "{{ keycloak_admin_secret_raw.stdout | from_json }}"
  changed_when: false
  no_log: true

- name: Resolve Keycloak admin creds from secret
  ansible.builtin.set_fact:
    keycloak_admin_user_effective: "{{ keycloak_admin_secret.username | default('') }}"
    keycloak_admin_password_effective: "{{ keycloak_admin_secret.password | default('') }}"
  changed_when: false
  no_log: true

- name: Assert Keycloak admin creds are present in secret
  ansible.builtin.assert:
    that:
      - keycloak_admin_user_effective | length > 0
      - keycloak_admin_password_effective | length > 0
    fail_msg: "Keycloak admin secret must include non-empty username and password."

- name: Resolve Keycloak DB credentials from secret
  ansible.builtin.set_fact:
    keycloak_db_username: "{{ keycloak_db_secret.username | default(keycloak_db_user) }}"
    keycloak_db_password_effective: "{{ keycloak_db_secret.password | default('') }}"
  changed_when: false
  no_log: true

- name: Assert Keycloak DB password is present in secret
  ansible.builtin.assert:
    that:
      - keycloak_db_password_effective | length > 0
    fail_msg: "Secrets Manager value must include a non-empty password."

- name: Write ephemeral Keycloak DB env file
  ansible.builtin.copy:
    dest: "{{ keycloak_runtime_dir }}/db.env"
    owner: root
    group: root
    mode: "0600"
    content: |
      KC_DB_USERNAME={{ keycloak_db_username }}
      KC_DB_PASSWORD={{ keycloak_db_password_effective }}
  no_log: true

- name: Check Keycloak container presence
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} container exists {{ keycloak_container_name }}"
  register: keycloak_container_exists
  failed_when: false
  changed_when: false

- name: Create Keycloak container
  ansible.builtin.command:
    cmd: >-
      {{ keycloak_podman_bin }} run -d
      --name {{ keycloak_container_name }}
      --network {{ keycloak_network_name }}
      --read-only
      --cap-drop=ALL
      --security-opt=no-new-privileges
      --pids-limit 200
      --memory 1g
      -p 127.0.0.1:8081:8080
      --env-file {{ keycloak_runtime_dir }}/db.env
      -e KEYCLOAK_ADMIN={{ keycloak_admin_user_effective }}
      -e KEYCLOAK_ADMIN_PASSWORD={{ keycloak_admin_password_effective }}
      -e KC_DB=postgres
      -e KC_DB_URL_HOST={{ keycloak_db_host }}
      -e KC_DB_URL_PORT={{ keycloak_db_port }}
      -e KC_DB_URL_DATABASE={{ keycloak_db_name }}
      -e KC_PROXY=edge
      -e KC_HOSTNAME={{ keycloak_hostname }}
      -e KC_HOSTNAME_STRICT={{ keycloak_hostname_strict | ternary('true', 'false') }}
      -e KC_HTTP_ENABLED=true
      {{ keycloak_image }}
      start
      --optimized
  when: keycloak_container_exists.rc != 0
  changed_when: true
  no_log: true

- name: Inspect Keycloak container running state
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} inspect -f {{ '{{.State.Running}}' }} {{ keycloak_container_name }}"
  register: keycloak_running
  failed_when: false
  changed_when: false
  when: keycloak_container_exists.rc == 0

- name: Start Keycloak container if stopped
  ansible.builtin.command:
    cmd: "{{ keycloak_podman_bin }} start {{ keycloak_container_name }}"
  when:
    - keycloak_container_exists.rc == 0
    - keycloak_running.stdout | trim != 'true'
  changed_when: true

- name: Capture Keycloak audit artifacts
  ansible.builtin.shell: |
    set -euo pipefail
    {{ keycloak_podman_bin }} inspect {{ keycloak_container_name }} > {{ keycloak_audit_dir }}/keycloak_container_inspect.json
    {{ keycloak_podman_bin }} image inspect {{ keycloak_image }} > {{ keycloak_audit_dir }}/keycloak_image_inspect.json
    cat > {{ keycloak_audit_dir }}/keycloak_config_effective.txt <<'CFG'
    keycloak_container_name={{ keycloak_container_name }}
    keycloak_image={{ keycloak_image }}
    keycloak_network_name={{ keycloak_network_name }}
    keycloak_bind=127.0.0.1:8081->8080
    keycloak_db_mode={{ keycloak_db_mode }}
    keycloak_db_host={{ keycloak_db_host }}
    keycloak_db_port={{ keycloak_db_port }}
    keycloak_db_name={{ keycloak_db_name }}
    keycloak_db_user={{ keycloak_db_username }}
    keycloak_hostname={{ keycloak_hostname }}
    keycloak_hostname_strict={{ keycloak_hostname_strict | ternary('true', 'false') }}
    CFG
    printf '%s\n' '{{ keycloak_db_secret_arn }}' > {{ keycloak_audit_dir }}/keycloak_secret_arn_used.txt
  changed_when: true
