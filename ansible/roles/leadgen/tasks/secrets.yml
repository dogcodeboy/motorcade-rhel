---
- name: "LeadGen | assert required secret IDs are set"
  ansible.builtin.assert:
    that:
      - leadgen_db_secret_id is defined
      - leadgen_intake_api_key_secret_id is defined
      - leadgen_db_secret_id | length > 8
      - leadgen_intake_api_key_secret_id | length > 8
    fail_msg: "LeadGen secret IDs missing: set leadgen_db_secret_id and leadgen_intake_api_key_secret_id in inventory."
  become: false

- name: "LeadGen | fetch DB secret (SecretString JSON)"
  ansible.builtin.command: >
    aws secretsmanager get-secret-value
    --secret-id {{ leadgen_db_secret_id }}
    --query SecretString
    --output text
  register: _leadgen_db_secret_raw
  changed_when: false
  no_log: true

- name: "LeadGen | parse DB secret JSON"
  ansible.builtin.set_fact:
    leadgen_db_secret: "{{ _leadgen_db_secret_raw.stdout | from_json }}"
  no_log: true

- name: "LeadGen | validate DB secret schema"
  ansible.builtin.assert:
    that:
      - (leadgen_db_secret.host is defined) or (leadgen_db_secret.endpoint is defined)
      - (leadgen_db_secret.username is defined) or (leadgen_db_secret.user is defined)
      - leadgen_db_secret.password is defined
    fail_msg: "LeadGen DB secret JSON missing required keys (host|endpoint, username|user, password)."
  no_log: true

- name: "LeadGen | normalize DB vars"
  ansible.builtin.set_fact:
    leadgen_db_host: "{{ leadgen_db_secret.host | default(leadgen_db_secret.endpoint) }}"
    leadgen_db_port: "{{ leadgen_db_secret.port | default(5432) }}"
    leadgen_db_name: "{{ leadgen_db_secret.dbname | default('leadgen') }}"
    leadgen_db_user: "{{ leadgen_db_secret.username | default(leadgen_db_secret.user) }}"
    leadgen_db_password: "{{ leadgen_db_secret.password }}"
    leadgen_db_sslmode: "{{ leadgen_db_secret.sslmode | default('require') }}"
  no_log: true

- name: "LeadGen | fetch Intake API key secret (SecretString JSON)"
  ansible.builtin.command: >
    aws secretsmanager get-secret-value
    --secret-id {{ leadgen_intake_api_key_secret_id }}
    --query SecretString
    --output text
  register: _leadgen_api_key_secret_raw
  changed_when: false
  no_log: true

- name: "LeadGen | parse Intake API key secret JSON"
  ansible.builtin.set_fact:
    leadgen_api_key_secret: "{{ _leadgen_api_key_secret_raw.stdout | from_json }}"
  no_log: true

- name: "LeadGen | validate Intake API key schema"
  ansible.builtin.assert:
    that:
      - (leadgen_api_key_secret.api_key is defined) or (leadgen_api_key_secret.key is defined)
    fail_msg: "LeadGen intake api key secret JSON must include api_key or key."
  no_log: true

- name: "LeadGen | normalize Intake API key"
  ansible.builtin.set_fact:
    leadgen_intake_api_key: "{{ leadgen_api_key_secret.api_key | default(leadgen_api_key_secret.key) }}"
  no_log: true

- name: "LeadGen | ensure runtime dir exists"
  ansible.builtin.file:
    path: /run/motorcade/leadgen
    state: directory
    owner: root
    group: root
    mode: "0700"
  become: true

- name: "LeadGen | render runtime env file"
  ansible.builtin.template:
    src: leadgen.env.j2
    dest: /run/motorcade/leadgen/leadgen.env
    owner: root
    group: root
    mode: "0600"
  become: true
  no_log: true
