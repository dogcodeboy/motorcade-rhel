---
- name: "LeadGen | install quadlet unit"
  ansible.builtin.template:
    src: motorcade-leadgen.container.j2
    dest: /etc/containers/systemd/motorcade-leadgen.container
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - systemd daemon-reload
    - restart leadgen

- name: "LeadGen | reload systemd for quadlet units"
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: "LeadGen | derive ECR registry host from image ref"
  ansible.builtin.set_fact:
    leadgen_ecr_registry_host: "{{ (leadgen_image_ref | string).split('/')[0] }}"
    leadgen_ecr_region: "{{ (leadgen_image_ref | regex_replace('^.*\\.ecr\\.([^.]+)\\.amazonaws\\.com.*$', '\\1')) | default('us-east-2') }}"
  changed_when: false

- name: "LeadGen | login to ECR for image pulls"
  ansible.builtin.shell: |
    set -euo pipefail
    PASS="$(aws ecr get-login-password --region "{{ leadgen_ecr_region }}")"
    printf "%s" "$PASS" | podman login --username AWS --password-stdin "{{ leadgen_ecr_registry_host }}"
  args:
    executable: /bin/bash
  become: true
  changed_when: false

- name: "LeadGen | enable and start"
  ansible.builtin.systemd:
    name: motorcade-leadgen.service
    state: started
    enabled: true
  become: true
