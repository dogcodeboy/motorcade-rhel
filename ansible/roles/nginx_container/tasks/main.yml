---
- name: Assert required nginx container vars
  ansible.builtin.assert:
    that:
      - motorcade_nginx_tls_cert_dir | length > 0
      - (motorcade_nginx_domains | length > 0) or (motorcade_nginx_vhosts | length > 0)
    fail_msg: >-
      Missing required vars: define motorcade_nginx_domains or motorcade_nginx_vhosts,
      and set motorcade_nginx_tls_cert_dir.

- name: Initialize effective proxy upstream map
  ansible.builtin.set_fact:
    motorcade_nginx_proxy_upstreams_effective: "{{ motorcade_nginx_proxy_upstreams | default({}) }}"
  changed_when: false

- name: Include Keycloak upstream in effective proxy map
  ansible.builtin.set_fact:
    motorcade_nginx_proxy_upstreams_effective: >-
      {{
        motorcade_nginx_proxy_upstreams_effective |
        combine({
          (keycloak_hostname | regex_replace('^https?://', '') | regex_replace('/.*$', '')): motorcade_nginx_keycloak_upstream
        })
      }}
  when: keycloak_hostname | default('') | length > 0
  changed_when: false

- name: Use explicit vhost definitions when provided
  ansible.builtin.set_fact:
    motorcade_nginx_effective_vhosts: "{{ motorcade_nginx_vhosts }}"
  when: motorcade_nginx_vhosts | length > 0
  changed_when: false

- name: Initialize generated vhost definitions
  ansible.builtin.set_fact:
    motorcade_nginx_effective_vhosts: []
  when: motorcade_nginx_vhosts | length == 0
  changed_when: false

- name: Generate vhost definitions from domain list
  ansible.builtin.set_fact:
    motorcade_nginx_effective_vhosts: >-
      {{
        motorcade_nginx_effective_vhosts + [ {
          'name': item,
          'server_name': item,
          'cert_name': item,
          'kind': ((item in motorcade_nginx_proxy_upstreams_effective) | ternary('proxy', 'static')),
          'upstream': (motorcade_nginx_proxy_upstreams_effective[item] | default('')),
          'root': motorcade_nginx_static_root
        } ]
      }}
  loop: "{{ motorcade_nginx_domains }}"
  when: motorcade_nginx_vhosts | length == 0

- name: Assert vhost definitions are valid
  ansible.builtin.assert:
    that:
      - item.server_name is defined
      - item.server_name | length > 0
      - item.kind | default('static') in ['static', 'proxy']
      - (item.kind | default('static') != 'proxy') or (item.upstream is defined and item.upstream | length > 0)
    fail_msg: "Invalid vhost definition: {{ item }}"
  loop: "{{ motorcade_nginx_effective_vhosts }}"

- name: Initialize cert domain list
  ansible.builtin.set_fact:
    motorcade_nginx_cert_domains: []
  changed_when: false

- name: Build cert domain list from effective vhosts
  ansible.builtin.set_fact:
    motorcade_nginx_cert_domains: "{{ motorcade_nginx_cert_domains + [ item.cert_name | default(item.server_name) ] }}"
  loop: "{{ motorcade_nginx_effective_vhosts }}"

- name: De-duplicate cert domain list
  ansible.builtin.set_fact:
    motorcade_nginx_cert_domains: "{{ motorcade_nginx_cert_domains | unique }}"
  changed_when: false

- name: Ensure audit directory exists
  ansible.builtin.file:
    path: "{{ motorcade_audit_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0750"

- name: Ensure nginx cert directory exists (host-side)
  ansible.builtin.file:
    path: "{{ motorcade_nginx_tls_cert_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0750"

- name: Generate self-signed certs when enabled
  ansible.builtin.command:
    cmd: >-
      openssl req -x509 -nodes -newkey rsa:2048
      -keyout {{ motorcade_nginx_tls_cert_dir }}/{{ item }}.key
      -out {{ motorcade_nginx_tls_cert_dir }}/{{ item }}.crt
      -days {{ motorcade_nginx_selfsigned_days }}
      -subj /CN={{ item }}
  args:
    creates: "{{ motorcade_nginx_tls_cert_dir }}/{{ item }}.crt"
  loop: "{{ motorcade_nginx_cert_domains }}"
  when: motorcade_nginx_selfsigned | bool

- name: Verify required cert/key files exist
  ansible.builtin.stat:
    path: "{{ motorcade_nginx_tls_cert_dir }}/{{ item.0 }}.{{ item.1 }}"
  loop: "{{ motorcade_nginx_cert_domains | product(['crt', 'key']) | list }}"
  register: cert_stats

- name: Fail if any TLS asset is missing
  ansible.builtin.assert:
    that:
      - item.stat.exists
    fail_msg: "Missing TLS file: {{ motorcade_nginx_tls_cert_dir }}/{{ item.item.0 }}.{{ item.item.1 }}"
  loop: "{{ cert_stats.results }}"

- name: Resolve podman binary
  ansible.builtin.command:
    cmd: "command -v {{ podman_bin | default('podman') }}"
  become: true
  register: podman_path
  changed_when: false

- name: Set podman bin
  ansible.builtin.set_fact:
    podman_bin: "{{ podman_path.stdout | trim }}"
  changed_when: false

- name: Create rendered nginx config staging dir
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /etc/motorcade/nginx
    - /etc/motorcade/nginx/conf.d

- name: Render nginx.conf
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/motorcade/nginx/nginx.conf
    owner: root
    group: root
    mode: "0644"

- name: Render snippets
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "/etc/motorcade/nginx/{{ item.dest }}"
    owner: root
    group: root
    mode: "0644"
  loop:
    - { src: "snippets/ssl_params.conf.j2", dest: "ssl_params.conf" }
    - { src: "snippets/security_headers.conf.j2", dest: "security_headers.conf" }

- name: Build expected vhost filenames
  ansible.builtin.set_fact:
    motorcade_nginx_expected_conf_files: "{{ (motorcade_nginx_expected_conf_files | default([])) + [ (item.server_name + '.conf') ] }}"
  loop: "{{ motorcade_nginx_effective_vhosts }}"
  changed_when: false

- name: Find existing vhost conf files
  ansible.builtin.find:
    paths: /etc/motorcade/nginx/conf.d
    patterns: "*.conf"
    file_type: file
  register: motorcade_nginx_existing_conf_files

- name: Remove stale vhost conf files
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ motorcade_nginx_existing_conf_files.files }}"
  when: (item.path | basename) not in motorcade_nginx_expected_conf_files

- name: Render vhosts from inventory-driven definitions
  ansible.builtin.template:
    src: "conf.d/vhost.conf.j2"
    dest: "/etc/motorcade/nginx/conf.d/{{ item.server_name }}.conf"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ motorcade_nginx_effective_vhosts }}"

- name: Remove existing nginx container (idempotent recreate)
  ansible.builtin.command:
    cmd: "{{ podman_bin }} rm -f motorcade-nginx"
  failed_when: false
  changed_when: false

- name: Run nginx container (host networking binds 80/443)
  ansible.builtin.command:
    cmd: >-
      {{ podman_bin }} run --cap-add=SETGID --cap-add=SETUID --replace --cap-add=NET_BIND_SERVICE --cap-add=CHOWN --userns=host -v /srv/motorcade/nginx/cache:/var/cache/nginx:Z -v /srv/motorcade/nginx/run:/var/run:Z -v /srv/motorcade/nginx/tmp:/tmp:Z -d --name motorcade-nginx
      -p {{ motorcade_nginx_bind_http }}:{{ motorcade_nginx_container_http }}
      -p {{ motorcade_nginx_bind_https }}:{{ motorcade_nginx_container_https }}
      -v /etc/motorcade/nginx/nginx.conf:/etc/nginx/nginx.conf:ro,Z
      -v /etc/motorcade/nginx/ssl_params.conf:/etc/nginx/snippets/ssl_params.conf:ro,Z
      -v /etc/motorcade/nginx/security_headers.conf:/etc/nginx/snippets/security_headers.conf:ro,Z
      -v /etc/motorcade/nginx/conf.d:/etc/nginx/conf.d:ro,Z
      -v {{ motorcade_nginx_tls_cert_dir }}:/etc/nginx/certs:ro,Z
      {{ motorcade_nginx_image }}
  register: nginx_run
  changed_when: true

- name: Capture nginx image + container inspect for audit
  ansible.builtin.shell: |
    set -euo pipefail
    {{ podman_bin }} image inspect {{ motorcade_nginx_image }} > {{ motorcade_audit_dir }}/nginx_image_inspect.json
    {{ podman_bin }} inspect motorcade-nginx > {{ motorcade_audit_dir }}/nginx_container_inspect.json
  changed_when: true

- name: Health check nginx inside container via host port 80
  ansible.builtin.uri:
    url: "http://127.0.0.1/healthz"
    return_content: true
  register: healthz
  failed_when: healthz.status != 200
